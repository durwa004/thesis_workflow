#module load R/3.5.0
library(cn.mops)

BAMFiles <- c("./ibio_output_files/BAVA0183A/BAVA0183A.recalibrated.bam", "./ibio_output_files/BW01/BW01.recalibrated.bam", "./ibio_output_files/ERR1545179/ERR1545179.recalibrated.bam", "./ibio_output_files/ERR1545182/ERR1545182.recalibrated.bam", "./ibio_output_files/ERR1545187/ERR1545187.recalibrated.bam", "./ibio_output_files/ERR1545188/ERR1545188.recalibrated.bam", "./ibio_output_files/ERR1545190/ERR1545190.recalibrated.bam", "./ibio_output_files/ERR1545189/ERR1545189.recalibrated.bam", "./ibio_output_files/ERR1545178/ERR1545178.recalibrated.bam", "./ibio_output_files/HANO0172A/HANO0172A.recalibrated.bam", "./ibio_output_files/K746/K746.recalibrated.bam", "./ibio_output_files/K747/K747.recalibrated.bam", "./ibio_output_files/SRR1046151/SRR1046151.recalibrated.bam", "./ibio_output_files/SRR2142163/SRR2142163.recalibrated.bam", "./ibio_output_files/SRR2142269/SRR2142269.recalibrated.bam", "./ibio_output_files/SRR1046147/SRR1046147.recalibrated.bam", "./ibio_output_files/HOLS0173A/HOLS0173A.recalibrated.bam", "./ibio_output_files/HOLS0174A/HOLS0174A.recalibrated.bam", "./ibio_output_files/HOLS0175A/HOLS0175A.recalibrated.bam", "./ibio_output_files/ERR1527967/ERR1527967.recalibrated.bam", "./ibio_output_files/OLDE0176A/OLDE0176A.recalibrated.bam", "./ibio_output_files/OLDE0177A/OLDE0177A.recalibrated.bam", "./ibio_output_files/SRR2142311/SRR2142311.recalibrated.bam", "./ibio_output_files/M10657/M10657.recalibrated.bam", "./ibio_output_files/M10656/M10656.recalibrated.bam", "./ibio_output_files/RAO310/RAO310.recalibrated.bam", "./ibio_output_files/RAO441/RAO441.recalibrated.bam", "./ibio_output_files/ERR1527972/ERR1527972.recalibrated.bam", "./ibio_output_files/SRR515206/SRR515206.recalibrated.bam", "./ibio_output_files/SRR515215/SRR515215.recalibrated.bam", "./ibio_output_files/SRR2103372/SRR2103372.recalibrated.bam", "./ibio_output_files/SRR515203/SRR515203.recalibrated.bam", "./ibio_output_files/SRR3900281/SRR3900281.recalibrated.bam", "./ibio_output_files/SRR4054241/SRR4054241.recalibrated.bam", "./ibio_output_files/SRR641364/SRR641364.recalibrated.bam", "./ibio_output_files/SRR641365/SRR641365.recalibrated.bam", "./ibio_output_files/SRR641366/SRR641366.recalibrated.bam", "./ibio_output_files/SRR641367/SRR641367.recalibrated.bam", "./ibio_output_files/SRR505867/SRR505867.recalibrated.bam", "./ibio_output_files/SRR515202/SRR515202.recalibrated.bam", "./ibio_output_files/SRR515204/SRR515204.recalibrated.bam", "./ibio_output_files/SRR515205/SRR515205.recalibrated.bam", "./ibio_output_files/SRR515208/SRR515208.recalibrated.bam", "./ibio_output_files/SRR515209/SRR515209.recalibrated.bam", "./ibio_output_files/SRR515217/SRR515217.recalibrated.bam", "./ibio_output_files/SRR515211/SRR515211.recalibrated.bam", "./ibio_output_files/SRR515212/SRR515212.recalibrated.bam", "./ibio_output_files/SRR515213/SRR515213.recalibrated.bam", "./ibio_output_files/SRR515214/SRR515214.recalibrated.bam", "./ibio_output_files/SRR515216/SRR515216.recalibrated.bam", "./ibio_output_files/SRR6374293/SRR6374293.recalibrated.bam", "./ibio_output_files/ADM9/ADM9.recalibrated.bam", "./ibio_output_files/ADR419/ADR419.recalibrated.bam", "./ibio_output_files/ADR420/ADR420.recalibrated.bam", "./ibio_output_files/ADR421/ADR421.recalibrated.bam", "./ibio_output_files/ADR422/ADR422.recalibrated.bam", "./ibio_output_files/ADR423/ADR423.recalibrated.bam", "./ibio_output_files/ADR424/ADR424.recalibrated.bam", "./ibio_output_files/ADR425/ADR425.recalibrated.bam", "./ibio_output_files/M8457/M8457.recalibrated.bam", "./ibio_output_files/M8466/M8466.recalibrated.bam", "./ibio_output_files/M8461/M8461.recalibrated.bam", "./ibio_output_files/M8458/M8458.recalibrated.bam", "./ibio_output_files/M8465/M8465.recalibrated.bam", "./ibio_output_files/M8464/M8464.recalibrated.bam", "./ibio_output_files/M8463/M8463.recalibrated.bam", "./ibio_output_files/M8459/M8459.recalibrated.bam", "./ibio_output_files/M8467/M8467.recalibrated.bam", "./ibio_output_files/M8460/M8460.recalibrated.bam", "./ibio_output_files/M1503/M1503.recalibrated.bam", "./ibio_output_files/M1505/M1505.recalibrated.bam", "./ibio_output_files/M1506/M1506.recalibrated.bam", "./ibio_output_files/M1507/M1507.recalibrated.bam", "./ibio_output_files/M1510/M1510.recalibrated.bam", "./ibio_output_files/M1514/M1514.recalibrated.bam", "./ibio_output_files/M1516/M1516.recalibrated.bam", "./ibio_output_files/M1518/M1518.recalibrated.bam", "./ibio_output_files/M1519/M1519.recalibrated.bam", "./ibio_output_files/M1555/M1555.recalibrated.bam", "./ibio_output_files/SRR2102896/SRR2102896.recalibrated.bam", "./ibio_output_files/SRR4054240/SRR4054240.recalibrated.bam", "./ibio_output_files/M11022/M11022.recalibrated.bam", "./ibio_output_files/TRAK0178A/TRAK0178A.recalibrated.bam", "./ibio_output_files/TRAK0179A/TRAK0179A.recalibrated.bam", "./ibio_output_files/UKH3/UKH3.recalibrated.bam", "./ibio_output_files/M10662/M10662.recalibrated.bam", "./ibio_output_files/M10663/M10663.recalibrated.bam", "./ibio_output_files/WEST180A/WEST180A.recalibrated.bam", "./ibio_output_files/WEST181A/WEST181A.recalibrated.bam")
RefSeqNames = c("NC_009144.3", "NC_009145.3", "NC_009146.3", "NC_009147.3", "NC_009148.3", "NC_009149.3", "NC_009150.3", "NC_009151.3", "NC_009152.3", "NC_009153.3", "NC_009154.3", "NC_009155.3", "NC_009156.3", "NC_009157.3", "NC_009158.3", "NC_009159.3", "NC_009160.3", "NC_009161.3", "NC_009162.3", "NC_009163.3", "NC_009164.3", "NC_009165.3", "NC_009166.3", "NC_009167.3", "NC_009168.3", "NC_009169.3", "NC_009170.3", "NC_009171.3", "NC_009172.3", "NC_009173.3", "NC_009174.3", "NC_009175.3", "NC_001640.1")
sampleNames = c("BAVA0183A", "BW01", "ERR1545179", "ERR1545182", "ERR1545187", "ERR1545188", "ERR1545190", "ERR1545189", "ERR1545178", "HANO0172A", "K746", "K747", "SRR1046151", "SRR2142163", "SRR2142269", "SRR1046147", "HOLS0173A", "HOLS0174A", "HOLS0175A", "ERR1527967", "OLDE0176A", "OLDE0177A", "SRR2142311", "M10657", "M10656", "RAO310", "RAO441", "ERR1527972", "SRR515206", "SRR515215", "SRR2103372", "SRR515203", "SRR3900281", "SRR4054241", "SRR641364", "SRR641365", "SRR641366", "SRR641367", "SRR505867", "SRR515202", "SRR515204", "SRR515205", "SRR515208", "SRR515209", "SRR515217", "SRR515211", "SRR515212", "SRR515213", "SRR515214", "SRR515216", "SRR6374293", "ADM9", "ADR419", "ADR420", "ADR421", "ADR422", "ADR423", "ADR424", "ADR425", "M8457", "M8466", "M8461", "M8458", "M8465", "M8464", "M8463", "M8459", "M8467", "M8460", "M1503", "M1505", "M1506", "M1507", "M1510", "M1514", "M1516", "M1518", "M1519", "M1555", "SRR2102896", "SRR4054240", "M11022", "TRAK0178A", "TRAK0179A", "UKH3", "M10662", "M10663", "WEST180A", "WEST181A")
bamDataRanges <- getReadCountsFromBAM(BAMFiles,sampleNames, RefSeqNames, WL = 5000, parallel=4)
res <- cn.mops(bamDataRanges)
#Calculate integer copy numbers
results <- calcIntegerCopyNumbers(res)
segm <- as.data.frame(segmentation(results))
#Identify CNVs
CNVs <- as.data.frame(cnvs(results))
#Identify CNV regions
CNVRegions <- as.data.frame(cnvr(results))
#Output data
write.csv(segm,file='ibio_tb_segmentation.csv')
write.csv(CNVs,file='ibio_tb_CNVs.csv')
write.csv(CNVRegions,file='ibio_tb_CNVR.csv')
